name: Update Test262 Stats

on:
  schedule:
    - cron: '0 0 * * *' # Daily at midnight UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if should run
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger detected. Running."
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Last commit author: $LAST_AUTHOR"
          
          if [[ "$LAST_AUTHOR" == "GitHub Action" ]]; then
            echo "Last commit was by GitHub Action. No new changes since last run."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "New changes detected."
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

      - name: install
        if: steps.check.outputs.should_run == 'true'
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Run Test262 suite
        id: run_tests
        if: steps.check.outputs.should_run == 'true'
        # Run tests and capture output, allow failure
        run: |
          moon test --package oboard/tutujs/test --target wasm > test_output.txt 2>&1 || true
          cat test_output.txt # Show output in CI logs

      - name: Calculate Statistics
        id: stats
        if: steps.check.outputs.should_run == 'true'
        run: |
          # Calculate total tests by counting test definitions in .mbt files
          TOTAL_TESTS=$(grep -r "test \"" test/*.mbt | wc -l)
          
          # Calculate failed tests by counting "FAILED: Test failed" in output
          FAILED_TESTS=$(grep "FAILED: Test failed" test_output.txt | wc -l)
          
          # Calculate passed tests
          PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
          
          echo "Total: $TOTAL_TESTS"
          echo "Failed: $FAILED_TESTS"
          echo "Passed: $PASSED_TESTS"
          
          echo "passed=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT

      - name: Generate Progress SVG
        if: steps.check.outputs.should_run == 'true'
        run: |
          python3 test/generate_progress_svg.py ${{ steps.stats.outputs.passed }} ${{ steps.stats.outputs.total }} test/test262_progress.svg

      - name: Commit and Push changes
        if: steps.check.outputs.should_run == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add test/test262_progress.svg
          # Only commit if there are changes (pass rate changed)
          git commit -m "chore: update Test262 progress stats [skip ci]" || echo "No changes to commit"
          git push